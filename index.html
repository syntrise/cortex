<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CORTEX v3.0 | Syntrise Admin</title>
  
  <!-- Gridstack.js -->
  <link href="https://cdn.jsdelivr.net/npm/gridstack@10/dist/gridstack.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/gridstack@10/dist/gridstack-all.js"></script>
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  
  <style>
    :root {
      --bg-primary: #09090b;
      --bg-secondary: #0f0f12;
      --bg-card: #18181b;
      --bg-card-hover: #1f1f23;
      --border: #27272a;
      --border-hover: #3f3f46;
      --text-primary: #fafafa;
      --text-secondary: #a1a1aa;
      --text-muted: #52525b;
      --accent: #f97316;
      --accent-hover: #ea580c;
      --blue: #3b82f6;
      --green: #22c55e;
      --yellow: #eab308;
      --red: #ef4444;
      --purple: #a855f7;
      --cyan: #06b6d4;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* ========== LOGIN ========== */
    .login-screen {
      position: fixed;
      inset: 0;
      background: var(--bg-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .login-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    
    .login-logo {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      margin: 0 auto 16px;
    }
    
    .login-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 6px;
      color: var(--accent);
    }
    
    .login-subtitle {
      color: var(--text-muted);
      margin-bottom: 28px;
      font-size: 14px;
    }
    
    .login-form { margin-bottom: 20px; }
    
    .login-input {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      margin-bottom: 12px;
      transition: border-color 0.2s;
    }
    
    .login-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .login-input::placeholder {
      color: var(--text-muted);
    }
    
    .login-btn {
      width: 100%;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.2s;
      border: none;
      margin-bottom: 10px;
    }
    
    .login-btn-primary {
      background: var(--accent);
      color: white;
    }
    
    .login-btn-primary:hover {
      background: var(--accent-hover);
    }
    
    .login-btn-google {
      background: #fff;
      color: #1f1f1f;
    }
    
    .login-btn-google:hover {
      background: #f4f4f5;
    }
    
    .login-divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
      color: var(--text-muted);
      font-size: 12px;
    }
    
    .login-divider::before,
    .login-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }
    
    .login-divider span { padding: 0 12px; }
    
    .login-error {
      margin-top: 16px;
      padding: 10px 14px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--red);
      border-radius: 8px;
      color: var(--red);
      font-size: 13px;
      display: none;
    }
    
    /* ========== HEADER ========== */
    .header {
      height: 56px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-left { display: flex; align-items: center; gap: 14px; }
    .logo { display: flex; align-items: center; gap: 8px; }
    
    .logo-icon {
      width: 30px;
      height: 30px;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      border-radius: 7px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
    }
    
    .logo-text { font-size: 17px; font-weight: 700; color: var(--accent); }
    
    .version-badge {
      font-size: 10px;
      color: var(--text-muted);
      background: var(--bg-card);
      padding: 3px 7px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }
    
    .header-center { display: flex; align-items: center; gap: 6px; }
    
    .header-btn {
      padding: 7px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.15s;
    }
    
    .header-btn:hover {
      background: var(--bg-card-hover);
      border-color: var(--border-hover);
      color: var(--text-primary);
    }
    
    .header-btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    
    .header-btn.primary:hover { background: var(--accent-hover); }
    .header-right { display: flex; align-items: center; gap: 10px; }
    
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .status-dot {
      width: 7px;
      height: 7px;
      background: var(--green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .user-menu {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 10px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 7px;
      cursor: pointer;
    }
    
    .user-avatar {
      width: 26px;
      height: 26px;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
    }
    
    .user-email {
      font-size: 12px;
      color: var(--text-secondary);
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* ========== TOOLBAR ========== */
    .toolbar {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 8px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .toolbar-left { display: flex; align-items: center; gap: 14px; }
    .toolbar-title { font-size: 12px; color: var(--text-muted); }
    
    .edit-mode-toggle {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 11px;
      color: var(--text-secondary);
    }
    
    .toggle-switch {
      width: 34px;
      height: 18px;
      background: var(--border);
      border-radius: 9px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .toggle-switch.active { background: var(--accent); }
    
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.2s;
    }
    
    .toggle-switch.active::after { transform: translateX(16px); }
    
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }
    
    /* ========== MAIN CONTENT ========== */
    .main-content {
      padding: 16px;
      min-height: calc(100vh - 100px);
    }
    
    /* ========== GRIDSTACK ========== */
    .grid-stack { background: transparent; }
    
    .grid-stack-item-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .grid-stack-item-content:hover { border-color: var(--border-hover); }
    
    .gs-item-dragging .grid-stack-item-content {
      box-shadow: 0 16px 32px rgba(0,0,0,0.4);
      border-color: var(--accent);
    }
    
    /* ========== WIDGET COMMON ========== */
    .widget-header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255,255,255,0.01);
      cursor: move;
      flex-shrink: 0;
    }
    
    .widget-title {
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .widget-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--bg-secondary);
      border-radius: 4px;
      color: var(--text-muted);
    }
    
    .widget-actions { display: flex; gap: 3px; }
    
    .widget-action {
      width: 26px;
      height: 26px;
      background: transparent;
      border: none;
      border-radius: 5px;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      transition: all 0.15s;
    }
    
    .widget-action:hover {
      background: var(--bg-card-hover);
      color: var(--text-primary);
    }
    
    .widget-body { 
      padding: 14px; 
      flex: 1; 
      overflow: auto;
      min-height: 0;
    }
    .widget-body.no-padding { padding: 0; }
    
    /* ========== KPI CARDS ========== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      height: 100%;
    }
    
    .kpi-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      transition: all 0.2s;
    }
    
    .kpi-card:hover {
      border-color: var(--border-hover);
      transform: translateY(-1px);
    }
    
    .kpi-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      margin-bottom: 10px;
    }
    
    .kpi-icon.blue { background: rgba(59, 130, 246, 0.15); }
    .kpi-icon.green { background: rgba(34, 197, 94, 0.15); }
    .kpi-icon.yellow { background: rgba(234, 179, 8, 0.15); }
    .kpi-icon.purple { background: rgba(168, 85, 247, 0.15); }
    .kpi-icon.cyan { background: rgba(6, 182, 212, 0.15); }
    .kpi-icon.red { background: rgba(239, 68, 68, 0.15); }
    
    .kpi-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    
    .kpi-value { font-size: 24px; font-weight: 700; line-height: 1.1; }
    .kpi-value.blue { color: var(--blue); }
    .kpi-value.green { color: var(--green); }
    .kpi-value.yellow { color: var(--yellow); }
    .kpi-value.purple { color: var(--purple); }
    .kpi-value.cyan { color: var(--cyan); }
    .kpi-value.red { color: var(--red); }
    
    .kpi-change {
      margin-top: auto;
      padding-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .kpi-change.positive { color: var(--green); }
    .kpi-change.negative { color: var(--red); }
    
    /* ========== HEALTH GRID ========== */
    .health-list { display: flex; flex-direction: column; gap: 8px; }
    
    .health-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border-radius: 7px;
    }
    
    .health-name { font-size: 12px; color: var(--text-secondary); }
    
    .health-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .health-status {
      font-size: 11px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .health-status.ok { color: var(--green); }
    .health-status.warn { color: var(--yellow); }
    .health-status.error { color: var(--red); }
    .health-status.checking { color: var(--text-muted); }
    
    .health-latency {
      font-size: 10px;
      color: var(--text-muted);
    }
    
    /* ========== PROVIDERS ========== */
    .providers-grid { display: flex; flex-direction: column; gap: 10px; }
    
    .provider-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
    }
    
    .provider-card.healthy { border-color: rgba(34, 197, 94, 0.3); }
    .provider-card.warning { border-color: rgba(234, 179, 8, 0.3); }
    
    .provider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .provider-name {
      font-size: 12px;
      font-weight: 600;
    }
    
    .provider-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .provider-status-dot.healthy { background: var(--green); }
    .provider-status-dot.warning { background: var(--yellow); }
    
    .provider-stats { display: flex; flex-direction: column; gap: 6px; }
    
    .provider-stat {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
    }
    
    .provider-stat .label { color: var(--text-muted); }
    .provider-stat .value { color: var(--text-secondary); }
    .provider-stat .cost { color: var(--purple); font-weight: 600; }
    
    .provider-bar {
      height: 3px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 8px;
      overflow: hidden;
    }
    
    .provider-bar-fill {
      height: 100%;
      background: var(--green);
      border-radius: 2px;
    }
    
    /* ========== BREAKDOWN ========== */
    .breakdown-list { display: flex; flex-direction: column; gap: 8px; }
    
    .breakdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .breakdown-icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      background: var(--bg-secondary);
    }
    
    .breakdown-info { flex: 1; }
    .breakdown-name { font-size: 12px; color: var(--text-secondary); }
    
    .breakdown-bar {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 4px;
      overflow: hidden;
    }
    
    .breakdown-bar-fill {
      height: 100%;
      border-radius: 2px;
    }
    
    .breakdown-count {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    /* ========== COMMANDS TABLE ========== */
    .commands-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    
    .commands-table th {
      text-align: left;
      padding: 8px 10px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      background: var(--bg-card);
      position: sticky;
      top: 0;
    }
    
    .commands-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
    }
    
    .commands-table tr:hover {
      background: var(--bg-secondary);
    }
    
    .user-id-cell {
      font-family: 'SF Mono', monospace;
      font-size: 11px;
      color: var(--blue);
    }
    
    .status-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
    }
    
    .status-badge.pending { background: rgba(234, 179, 8, 0.2); color: var(--yellow); }
    .status-badge.completed { background: rgba(34, 197, 94, 0.2); color: var(--green); }
    .status-badge.failed { background: rgba(239, 68, 68, 0.2); color: var(--red); }
    
    /* ========== TESTERS ========== */
    .testers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 10px;
    }
    
    .tester-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
    }
    
    .tester-card.active {
      border-color: rgba(34, 197, 94, 0.3);
    }
    
    .tester-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .tester-avatar {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
    }
    
    .tester-status {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .tester-status.online { background: rgba(34, 197, 94, 0.2); color: var(--green); }
    .tester-status.recent { background: rgba(59, 130, 246, 0.2); color: var(--blue); }
    .tester-status.offline { background: var(--bg-card); color: var(--text-muted); }
    
    .tester-name {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .tester-tier {
      font-size: 10px;
      color: var(--text-muted);
    }
    
    .tester-stats {
      display: flex;
      gap: 12px;
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
    }
    
    .tester-stat {
      text-align: center;
    }
    
    .tester-stat-value {
      font-size: 14px;
      font-weight: 600;
    }
    
    .tester-stat-label {
      font-size: 9px;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    
    /* ========== ACTIVITY TIMELINE ========== */
    .timeline { display: flex; flex-direction: column; gap: 6px; }
    
    .timeline-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      background: var(--bg-secondary);
      border-radius: 6px;
      font-size: 12px;
    }
    
    .timeline-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .timeline-dot.drop { background: var(--blue); }
    .timeline-dot.command { background: var(--purple); }
    
    .timeline-content { flex: 1; min-width: 0; }
    .timeline-text { color: var(--text-secondary); }
    .timeline-time { font-size: 11px; color: var(--text-muted); flex-shrink: 0; }
    
    /* ========== HOURLY CHART ========== */
    .hourly-chart {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 100%;
      min-height: 80px;
    }
    
    .hourly-bar {
      flex: 1;
      background: linear-gradient(to top, var(--accent), var(--yellow));
      border-radius: 2px 2px 0 0;
      min-height: 3px;
      transition: height 0.3s;
    }
    
    .hourly-bar:hover {
      opacity: 0.8;
    }
    
    /* ========== QUICK ACTIONS ========== */
    .quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .quick-btn {
      padding: 8px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .quick-btn:hover {
      background: var(--bg-card-hover);
      border-color: var(--border-hover);
      color: var(--text-primary);
    }
    
    .quick-btn.danger {
      color: var(--red);
      border-color: rgba(239, 68, 68, 0.3);
    }
    
    .quick-btn.danger:hover {
      background: rgba(239, 68, 68, 0.1);
    }
    
    /* ========== LOADING & EMPTY ========== */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      min-height: 60px;
      color: var(--text-muted);
      font-size: 12px;
    }
    
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      min-height: 80px;
      color: var(--text-muted);
      text-align: center;
    }
    
    .empty-state-icon { font-size: 28px; margin-bottom: 8px; opacity: 0.4; }
    .empty-state-text { font-size: 12px; }
    
    /* ========== TOAST ========== */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 12px;
      z-index: 1000;
      animation: slideIn 0.3s ease;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    
    @keyframes slideIn {
      from { transform: translateY(16px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    /* ========== RESPONSIVE ========== */
    @media (max-width: 1200px) {
      .kpi-grid { grid-template-columns: repeat(3, 1fr); }
    }
    
    @media (max-width: 768px) {
      .header { padding: 0 12px; }
      .header-center { display: none; }
      .main-content { padding: 10px; }
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-card">
      <div class="login-logo">üß†</div>
      <h1 class="login-title">CORTEX</h1>
      <p class="login-subtitle">Syntrise Admin Dashboard v3.0</p>
      
      <form class="login-form" id="loginForm">
        <input type="email" class="login-input" id="loginEmail" placeholder="Email" required>
        <input type="password" class="login-input" id="loginPassword" placeholder="Password" required>
        <button type="submit" class="login-btn login-btn-primary">Sign In</button>
      </form>
      
      <div class="login-divider"><span>or</span></div>
      
      <button class="login-btn login-btn-google" id="googleLoginBtn">
        <svg width="18" height="18" viewBox="0 0 18 18">
          <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
          <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/>
          <path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/>
          <path fill="#EA4335" d="M8.98 3.58c1.16 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.9z"/>
        </svg>
        Sign in with Google
      </button>
      
      <div class="login-error" id="loginError"></div>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" style="display: none;">
    <header class="header">
      <div class="header-left">
        <div class="logo">
          <div class="logo-icon">üß†</div>
          <span class="logo-text">CORTEX</span>
        </div>
        <span class="version-badge">v3.0</span>
      </div>
      
      <div class="header-center">
        <button class="header-btn" id="healthCheckBtn">‚ö° Health Check</button>
        <button class="header-btn" id="addWidgetBtn">‚ûï Widget</button>
        <button class="header-btn" id="resetLayoutBtn">‚Ü∫ Reset</button>
        <button class="header-btn primary" id="saveLayoutBtn">üíæ Save</button>
      </div>
      
      <div class="header-right">
        <div class="status-indicator">
          <span class="status-dot" id="connectionDot"></span>
          <span id="connectionStatus">Connecting...</span>
        </div>
        <div class="user-menu" id="userMenu">
          <div class="user-avatar" id="userAvatar">?</div>
          <span class="user-email" id="userEmail">loading...</span>
        </div>
      </div>
    </header>
    
    <div class="toolbar">
      <div class="toolbar-left">
        <span class="toolbar-title">üìä Dashboard ‚Äî Drag widgets to customize</span>
        <div class="edit-mode-toggle">
          <span>Edit Mode</span>
          <div class="toggle-switch active" id="editModeToggle"></div>
        </div>
      </div>
      <div class="toolbar-right">
        <span>Last refresh: <span id="lastRefresh">--</span></span>
        <button class="header-btn" id="refreshBtn">üîÑ</button>
      </div>
    </div>
    
    <main class="main-content">
      <div class="grid-stack" id="grid"></div>
    </main>
  </div>

  <script>
    // ============ CONFIG ============
    const SUPABASE_URL = 'https://ughfdhmyflotgsysvrrc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnaGZkaG15ZmxvdGdzeXN2cnJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQwMzA3MjQsImV4cCI6MjA0OTYwNjcyNH0.aKey9jSIlAzDdVobXdV9W2bJL1FY0BVwlALOoXjHn1w';
    
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // ============ STATE ============
    let currentUser = null;
    let grid = null;
    let editMode = true;
    let charts = {};
    
    // Cached data
    const cache = {
      drops: [],
      commands: [],
      users: [],
      apiCosts: [],
      embeddings: 0
    };
    
    // ============ DEFAULT LAYOUT ============
    const DEFAULT_LAYOUT = [
      { x: 0, y: 0, w: 12, h: 2, id: 'kpi' },
      { x: 0, y: 2, w: 4, h: 4, id: 'health' },
      { x: 4, y: 2, w: 4, h: 4, id: 'providers' },
      { x: 8, y: 2, w: 4, h: 4, id: 'breakdown' },
      { x: 0, y: 6, w: 6, h: 4, id: 'commands' },
      { x: 6, y: 6, w: 6, h: 4, id: 'testers' },
      { x: 0, y: 10, w: 4, h: 3, id: 'hourly' },
      { x: 4, y: 10, w: 4, h: 3, id: 'timeline' },
      { x: 8, y: 10, w: 4, h: 3, id: 'actions' }
    ];
    
    // ============ WIDGET DEFINITIONS ============
    const WIDGETS = {
      kpi: { title: 'üìä Overview', minW: 4, minH: 2, render: renderKPIWidget },
      health: { title: 'üíö System Health', minW: 2, minH: 2, render: renderHealthWidget },
      providers: { title: 'ü§ñ AI Providers', minW: 2, minH: 3, render: renderProvidersWidget },
      breakdown: { title: 'üì¶ Drops by Type', minW: 2, minH: 2, render: renderBreakdownWidget },
      commands: { title: '‚ö° Recent Commands', minW: 3, minH: 3, render: renderCommandsWidget },
      testers: { title: 'üë• Beta Testers', minW: 3, minH: 3, render: renderTestersWidget },
      hourly: { title: 'üìà 24h Activity', minW: 2, minH: 2, render: renderHourlyWidget },
      timeline: { title: 'üïê Activity Feed', minW: 2, minH: 2, render: renderTimelineWidget },
      actions: { title: '‚ö° Quick Actions', minW: 2, minH: 2, render: renderActionsWidget }
    };
    
    // ============ API HELPER ============
    async function query(path) {
      const start = Date.now();
      try {
        const session = (await sb.auth.getSession()).data.session;
        const token = session?.access_token || SUPABASE_KEY;
        
        const response = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${token}`
          }
        });
        
        const latency = Date.now() - start;
        const data = await response.json();
        return { data, latency, error: null };
      } catch (error) {
        return { data: null, latency: Date.now() - start, error };
      }
    }
    
    async function queryCount(table) {
      try {
        const session = (await sb.auth.getSession()).data.session;
        const token = session?.access_token || SUPABASE_KEY;
        
        const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}?select=id`, {
          method: 'HEAD',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${token}`,
            'Prefer': 'count=exact'
          }
        });
        
        return parseInt(response.headers.get('content-range')?.split('/')[1] || '0');
      } catch (e) {
        return 0;
      }
    }
    
    async function workerCall(action) {
      const start = Date.now();
      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/core-worker`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_KEY}`
          },
          body: JSON.stringify({ action })
        });
        const latency = Date.now() - start;
        const data = await response.json();
        return { data, latency, error: null };
      } catch (error) {
        return { data: null, latency: Date.now() - start, error };
      }
    }
    
    // ============ INITIALIZATION ============
    async function init() {
      console.log('[Init] CORTEX v3 starting...');
      
      // Attach event listeners
      document.getElementById('loginForm').addEventListener('submit', handleEmailLogin);
      document.getElementById('googleLoginBtn').addEventListener('click', handleGoogleLogin);
      document.getElementById('healthCheckBtn').addEventListener('click', healthCheck);
      document.getElementById('addWidgetBtn').addEventListener('click', addWidget);
      document.getElementById('resetLayoutBtn').addEventListener('click', resetLayout);
      document.getElementById('saveLayoutBtn').addEventListener('click', saveLayout);
      document.getElementById('editModeToggle').addEventListener('click', toggleEditMode);
      document.getElementById('refreshBtn').addEventListener('click', refreshAll);
      document.getElementById('userMenu').addEventListener('click', handleLogout);
      
      // Check existing session
      try {
        const { data: { session } } = await sb.auth.getSession();
        console.log('[Init] Session:', session?.user?.email || 'none');
        
        if (session?.user) {
          await verifyAccess(session);
        }
      } catch (e) {
        console.error('[Init] Error:', e);
      }
      
      // Auth state listener
      sb.auth.onAuthStateChange(async (event, session) => {
        console.log('[Auth] Event:', event);
        if (event === 'SIGNED_IN' && session?.user) {
          await verifyAccess(session);
        }
      });
    }
    
    async function verifyAccess(session) {
      try {
        const { data: limits } = await sb
          .from('user_limits')
          .select('tier')
          .eq('user_id', session.user.id)
          .single();
        
        console.log('[Auth] Tier:', limits?.tier);
        
        if (limits?.tier === 'owner') {
          currentUser = session.user;
          if (window.location.hash) {
            history.replaceState(null, '', window.location.pathname);
          }
          showApp();
        } else {
          await sb.auth.signOut();
          showLoginError('Access denied. Owner account required.');
        }
      } catch (e) {
        console.error('[Auth] Error:', e);
        showLoginError('Error verifying access.');
      }
    }
    
    function showApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('userEmail').textContent = currentUser.email;
      document.getElementById('userAvatar').textContent = currentUser.email.charAt(0).toUpperCase();
      
      updateConnectionStatus(true);
      initGrid();
      refreshAll();
      
      // Auto-refresh every 30 seconds
      setInterval(refreshAll, 30000);
    }
    
    function initGrid() {
      grid = GridStack.init({
        column: 12,
        cellHeight: 70,
        margin: 6,
        float: false,
        animate: true,
        draggable: { handle: '.widget-header' },
        resizable: { handles: 'se, sw, e, w' }
      });
      
      const saved = localStorage.getItem('cortex_v3_layout');
      loadLayout(saved ? JSON.parse(saved) : DEFAULT_LAYOUT);
      grid.on('change', saveLayoutDebounced);
    }
    
    function loadLayout(layout) {
      grid.removeAll();
      layout.forEach(item => {
        const widget = WIDGETS[item.id];
        if (!widget) return;
        
        grid.addWidget({
          x: item.x, y: item.y, w: item.w, h: item.h,
          minW: widget.minW, minH: widget.minH,
          id: item.id,
          content: createWidgetHTML(item.id, widget.title)
        });
        widget.render(item.id);
      });
    }
    
    function createWidgetHTML(id, title) {
      return `
        <div class="widget-header">
          <span class="widget-title">${title}</span>
          <div class="widget-actions">
            <button class="widget-action" data-action="refresh" data-id="${id}">üîÑ</button>
            <button class="widget-action" data-action="remove" data-id="${id}">‚úï</button>
          </div>
        </div>
        <div class="widget-body" id="body-${id}">
          <div class="loading">Loading...</div>
        </div>
      `;
    }
    
    // Widget button delegation
    document.addEventListener('click', function(e) {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;
      
      const action = btn.dataset.action;
      const id = btn.dataset.id;
      
      if (action === 'refresh') {
        const w = WIDGETS[id];
        if (w?.render) w.render(id);
      }
      if (action === 'remove') removeWidget(id);
    });
    
    // ============ DATA LOADING ============
    async function refreshAll() {
      console.log('[Refresh] Loading data...');
      document.getElementById('lastRefresh').textContent = new Date().toLocaleTimeString();
      
      try {
        // Load all data in parallel
        const [dropsResult, commandsResult, limitsResult, costsResult] = await Promise.all([
          query('drops?select=id,user_id,category,drop_group,created_at&order=created_at.desc&limit=500'),
          query('command_drops?select=id,user_id,command_type,exec_status,created&order=created.desc&limit=100'),
          query('user_limits?select=user_id,tier'),
          query('api_costs?select=id,provider,model,cost_usd,tokens_input,tokens_output,created_at')
        ]);
        
        cache.drops = dropsResult.data || [];
        cache.commands = commandsResult.data || [];
        cache.users = limitsResult.data || [];
        cache.apiCosts = costsResult.data || [];
        cache.embeddings = await queryCount('drop_embeddings');
        
        // Re-render all visible widgets
        Object.keys(WIDGETS).forEach(id => {
          if (document.getElementById(`body-${id}`)) {
            WIDGETS[id].render(id);
          }
        });
        
        updateConnectionStatus(true);
      } catch (e) {
        console.error('[Refresh] Error:', e);
        updateConnectionStatus(false);
      }
    }
    
    function updateConnectionStatus(connected) {
      const dot = document.getElementById('connectionDot');
      const status = document.getElementById('connectionStatus');
      
      if (connected) {
        dot.style.background = 'var(--green)';
        status.textContent = 'Connected';
      } else {
        dot.style.background = 'var(--red)';
        status.textContent = 'Offline';
      }
    }
    
    // ============ WIDGET RENDERERS ============
    
    function renderKPIWidget(id) {
      const body = document.getElementById(`body-${id}`);
      
      const totalDrops = cache.drops.length;
      const today = new Date().toISOString().split('T')[0];
      const todayDrops = cache.drops.filter(d => d.created_at?.startsWith(today)).length;
      const uniqueUsers = [...new Set(cache.drops.map(d => d.user_id).filter(Boolean))].length;
      const totalCommands = cache.commands.length;
      const pendingCommands = cache.commands.filter(c => c.exec_status === 'pending').length;
      const totalCost = cache.apiCosts.reduce((sum, c) => sum + (parseFloat(c.cost_usd) || 0), 0);
      
      body.innerHTML = `
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-icon blue">üìù</div>
            <div class="kpi-label">Total Drops</div>
            <div class="kpi-value blue">${totalDrops.toLocaleString()}</div>
            <div class="kpi-change">All time</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-icon green">üìÖ</div>
            <div class="kpi-label">Today</div>
            <div class="kpi-value green">${todayDrops}</div>
            <div class="kpi-change">New drops</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-icon cyan">üë•</div>
            <div class="kpi-label">Users</div>
            <div class="kpi-value cyan">${uniqueUsers}</div>
            <div class="kpi-change">${cache.users.length} registered</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-icon yellow">‚ö°</div>
            <div class="kpi-label">Commands</div>
            <div class="kpi-value yellow">${totalCommands}</div>
            <div class="kpi-change">${pendingCommands} pending</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-icon purple">üß†</div>
            <div class="kpi-label">Embeddings</div>
            <div class="kpi-value purple">${cache.embeddings.toLocaleString()}</div>
            <div class="kpi-change">Vectors</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-icon red">üí∞</div>
            <div class="kpi-label">API Costs</div>
            <div class="kpi-value red">$${totalCost.toFixed(2)}</div>
            <div class="kpi-change">Total spend</div>
          </div>
        </div>
      `;
    }
    
    function renderHealthWidget(id) {
      const body = document.getElementById(`body-${id}`);
      body.innerHTML = `
        <div class="health-list">
          <div class="health-item">
            <span class="health-name">üóÑÔ∏è Supabase</span>
            <div class="health-right">
              <span class="health-status checking" id="health-supabase">‚è≥ Checking</span>
              <span class="health-latency" id="latency-supabase"></span>
            </div>
          </div>
          <div class="health-item">
            <span class="health-name">‚öôÔ∏è Worker</span>
            <div class="health-right">
              <span class="health-status checking" id="health-worker">‚è≥ Checking</span>
              <span class="health-latency" id="latency-worker"></span>
            </div>
          </div>
          <div class="health-item">
            <span class="health-name">ü§ñ Claude API</span>
            <div class="health-right">
              <span class="health-status checking" id="health-claude">‚è≥ Checking</span>
              <span class="health-latency" id="latency-claude"></span>
            </div>
          </div>
          <div class="health-item">
            <span class="health-name">üß† Embeddings</span>
            <div class="health-right">
              <span class="health-status checking" id="health-embeddings">‚è≥ Checking</span>
              <span class="health-latency" id="latency-embeddings"></span>
            </div>
          </div>
        </div>
      `;
      healthCheck();
    }
    
    async function healthCheck() {
      // Supabase
      const supabaseCheck = await query('drops?select=id&limit=1');
      updateHealthStatus('supabase', supabaseCheck.error ? 'error' : 'ok', supabaseCheck.latency);
      
      // Worker
      const workerCheck = await workerCall('ping');
      updateHealthStatus('worker', workerCheck.error ? 'error' : 'ok', workerCheck.latency);
      
      // Claude (check via worker)
      const claudeCheck = await workerCall('health_check');
      const claudeOk = claudeCheck.data?.claude === 'ok';
      updateHealthStatus('claude', claudeOk ? 'ok' : 'warn', null);
      
      // Embeddings (check count)
      const embCount = cache.embeddings;
      updateHealthStatus('embeddings', embCount > 0 ? 'ok' : 'warn', null);
    }
    
    function updateHealthStatus(service, status, latency) {
      const el = document.getElementById(`health-${service}`);
      const latencyEl = document.getElementById(`latency-${service}`);
      
      if (!el) return;
      
      if (status === 'ok') {
        el.textContent = '‚óè Online';
        el.className = 'health-status ok';
      } else if (status === 'warn') {
        el.textContent = '‚óè Warning';
        el.className = 'health-status warn';
      } else if (status === 'error') {
        el.textContent = '‚óè Offline';
        el.className = 'health-status error';
      }
      
      if (latencyEl && latency) {
        latencyEl.textContent = `${latency}ms`;
      }
    }
    
    function renderProvidersWidget(id) {
      const body = document.getElementById(`body-${id}`);
      
      // Group costs by provider
      const byProvider = {};
      cache.apiCosts.forEach(c => {
        const p = c.provider || 'unknown';
        if (!byProvider[p]) {
          byProvider[p] = { requests: 0, cost: 0, tokens: 0, models: new Set() };
        }
        byProvider[p].requests++;
        byProvider[p].cost += parseFloat(c.cost_usd) || 0;
        byProvider[p].tokens += (c.tokens_input || 0) + (c.tokens_output || 0);
        if (c.model) byProvider[p].models.add(c.model);
      });
      
      const anthropic = byProvider['anthropic'] || { requests: 0, cost: 0, tokens: 0 };
      const openaiCost = (cache.embeddings * 0.00002).toFixed(4);
      const elevenlabs = byProvider['elevenlabs'] || { requests: 0, cost: 0, tokens: 0 };
      
      body.innerHTML = `
        <div class="providers-grid">
          <div class="provider-card healthy">
            <div class="provider-header">
              <span class="provider-name">üü£ Anthropic Claude</span>
              <span class="provider-status-dot healthy"></span>
            </div>
            <div class="provider-stats">
              <div class="provider-stat"><span class="label">Requests</span><span class="value">${anthropic.requests}</span></div>
              <div class="provider-stat"><span class="label">Tokens</span><span class="value">${(anthropic.tokens / 1000000).toFixed(2)}M</span></div>
              <div class="provider-stat"><span class="label">Cost</span><span class="cost">$${anthropic.cost.toFixed(2)}</span></div>
            </div>
            <div class="provider-bar"><div class="provider-bar-fill" style="width: ${Math.min(anthropic.cost / 50 * 100, 100)}%"></div></div>
          </div>
          
          <div class="provider-card healthy">
            <div class="provider-header">
              <span class="provider-name">üü¢ OpenAI</span>
              <span class="provider-status-dot healthy"></span>
            </div>
            <div class="provider-stats">
              <div class="provider-stat"><span class="label">Model</span><span class="value">ada-002</span></div>
              <div class="provider-stat"><span class="label">Embeddings</span><span class="value">${cache.embeddings.toLocaleString()}</span></div>
              <div class="provider-stat"><span class="label">Est. Cost</span><span class="cost">~$${openaiCost}</span></div>
            </div>
            <div class="provider-bar"><div class="provider-bar-fill" style="width: ${Math.min(cache.embeddings / 5000 * 100, 100)}%"></div></div>
          </div>
          
          <div class="provider-card ${elevenlabs.requests > 0 ? 'healthy' : 'warning'}">
            <div class="provider-header">
              <span class="provider-name">üîä ElevenLabs</span>
              <span class="provider-status-dot ${elevenlabs.requests > 0 ? 'healthy' : 'warning'}"></span>
            </div>
            <div class="provider-stats">
              <div class="provider-stat"><span class="label">Service</span><span class="value">TTS</span></div>
              <div class="provider-stat"><span class="label">Requests</span><span class="value">${elevenlabs.requests || '‚Äî'}</span></div>
              <div class="provider-stat"><span class="label">Cost</span><span class="cost">${elevenlabs.cost ? '$' + elevenlabs.cost.toFixed(2) : '‚Äî'}</span></div>
            </div>
          </div>
        </div>
      `;
    }
    
    function renderBreakdownWidget(id) {
      const body = document.getElementById(`body-${id}`);
      
      // Group by category
      const byCategory = {};
      cache.drops.forEach(d => {
        const cat = d.category || 'uncategorized';
        byCategory[cat] = (byCategory[cat] || 0) + 1;
      });
      
      const sorted = Object.entries(byCategory).sort((a, b) => b[1] - a[1]);
      const maxCount = Math.max(...Object.values(byCategory), 1);
      
      const colors = {
        note: '#3b82f6',
        thought: '#a855f7',
        idea: '#22c55e',
        memory: '#06b6d4',
        command: '#f97316',
        uncategorized: '#71717a'
      };
      
      const icons = {
        note: 'üìù',
        thought: 'üí≠',
        idea: 'üí°',
        memory: 'üß†',
        command: '‚ö°',
        uncategorized: 'üì¶'
      };
      
      body.innerHTML = `
        <div class="breakdown-list">
          ${sorted.slice(0, 6).map(([cat, count]) => `
            <div class="breakdown-item">
              <div class="breakdown-icon">${icons[cat] || 'üì¶'}</div>
              <div class="breakdown-info">
                <div class="breakdown-name">${cat}</div>
                <div class="breakdown-bar">
                  <div class="breakdown-bar-fill" style="width: ${count / maxCount * 100}%; background: ${colors[cat] || '#71717a'}"></div>
                </div>
              </div>
              <div class="breakdown-count">${count}</div>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    function renderCommandsWidget(id) {
      const body = document.getElementById(`body-${id}`);
      body.classList.add('no-padding');
      
      const commands = cache.commands.slice(0, 10);
      
      if (commands.length === 0) {
        body.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö°</div><p class="empty-state-text">No commands yet</p></div>`;
        return;
      }
      
      body.innerHTML = `
        <table class="commands-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Type</th>
              <th>Status</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody>
            ${commands.map(c => `
              <tr>
                <td><span class="user-id-cell">${maskId(c.user_id)}</span></td>
                <td>${c.command_type || 'ask'}</td>
                <td><span class="status-badge ${c.exec_status || 'pending'}">${c.exec_status || 'pending'}</span></td>
                <td>${timeAgo(c.created)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }
    
    function renderTestersWidget(id) {
      const body = document.getElementById(`body-${id}`);
      
      // Group drops by user
      const byUser = {};
      cache.drops.forEach(d => {
        if (!d.user_id) return;
        if (!byUser[d.user_id]) {
          byUser[d.user_id] = { drops: 0, commands: 0, lastActivity: null };
        }
        byUser[d.user_id].drops++;
        if (d.drop_group === 'command') byUser[d.user_id].commands++;
        if (!byUser[d.user_id].lastActivity || d.created_at > byUser[d.user_id].lastActivity) {
          byUser[d.user_id].lastActivity = d.created_at;
        }
      });
      
      // Get tiers
      const tierMap = {};
      cache.users.forEach(u => tierMap[u.user_id] = u.tier);
      
      // Sort by activity
      const users = Object.entries(byUser)
        .map(([id, data]) => ({ id, ...data, tier: tierMap[id] || 'free' }))
        .sort((a, b) => new Date(b.lastActivity) - new Date(a.lastActivity))
        .slice(0, 8);
      
      if (users.length === 0) {
        body.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üë•</div><p class="empty-state-text">No users yet</p></div>`;
        return;
      }
      
      body.innerHTML = `
        <div class="testers-grid">
          ${users.map(u => {
            const hoursSince = (Date.now() - new Date(u.lastActivity)) / 3600000;
            let statusClass = 'offline';
            let statusText = Math.floor(hoursSince / 24) + 'd';
            if (hoursSince < 1) { statusClass = 'online'; statusText = 'Online'; }
            else if (hoursSince < 24) { statusClass = 'recent'; statusText = 'Today'; }
            
            return `
              <div class="tester-card ${hoursSince < 24 ? 'active' : ''}">
                <div class="tester-header">
                  <div class="tester-avatar">${u.id[0].toUpperCase()}</div>
                  <span class="tester-status ${statusClass}">${statusText}</span>
                </div>
                <div class="tester-name">${maskId(u.id)}</div>
                <div class="tester-tier">${u.tier}</div>
                <div class="tester-stats">
                  <div class="tester-stat">
                    <div class="tester-stat-value">${u.drops}</div>
                    <div class="tester-stat-label">Drops</div>
                  </div>
                  <div class="tester-stat">
                    <div class="tester-stat-value">${u.commands}</div>
                    <div class="tester-stat-label">Cmds</div>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
    
    function renderHourlyWidget(id) {
      const body = document.getElementById(`body-${id}`);
      
      // Group by hour (last 24h)
      const hourCounts = new Array(24).fill(0);
      const now = new Date();
      const h24ago = new Date(Date.now() - 24 * 3600000);
      
      cache.drops
        .filter(d => new Date(d.created_at) >= h24ago)
        .forEach(d => {
          const date = new Date(d.created_at);
          const hoursDiff = Math.floor((now - date) / 3600000);
          if (hoursDiff >= 0 && hoursDiff < 24) {
            hourCounts[23 - hoursDiff]++;
          }
        });
      
      const maxCount = Math.max(...hourCounts, 1);
      
      body.innerHTML = `
        <div class="hourly-chart">
          ${hourCounts.map((count, i) => `
            <div class="hourly-bar" style="height: ${Math.max(count / maxCount * 100, 3)}%" title="${count} drops"></div>
          `).join('')}
        </div>
      `;
    }
    
    function renderTimelineWidget(id) {
      const body = document.getElementById(`body-${id}`);
      
      const recent = cache.drops.slice(0, 8);
      
      if (recent.length === 0) {
        body.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üïê</div><p class="empty-state-text">No activity</p></div>`;
        return;
      }
      
      body.innerHTML = `
        <div class="timeline">
          ${recent.map(d => `
            <div class="timeline-item">
              <div class="timeline-dot ${d.drop_group === 'command' ? 'command' : 'drop'}"></div>
              <div class="timeline-content">
                <span class="timeline-text">${maskId(d.user_id)} ¬∑ ${d.category || d.drop_group || 'drop'}</span>
              </div>
              <span class="timeline-time">${timeAgo(d.created_at)}</span>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    function renderActionsWidget(id) {
      const body = document.getElementById(`body-${id}`);
      body.innerHTML = `
        <div class="quick-actions">
          <button class="quick-btn" data-worker="process_queue">üîÑ Process Queue</button>
          <button class="quick-btn" data-worker="process_events">‚ö° Process Events</button>
          <button class="quick-btn" data-worker="generate_embeddings">üß† Embeddings</button>
          <button class="quick-btn" data-worker="cleanup_expired">üßπ Cleanup</button>
          <button class="quick-btn danger" data-worker="dismiss_insights">üóëÔ∏è Clear Insights</button>
        </div>
      `;
    }
    
    // Quick actions delegation
    document.addEventListener('click', async function(e) {
      const btn = e.target.closest('[data-worker]');
      if (!btn) return;
      
      const action = btn.dataset.worker;
      btn.disabled = true;
      btn.textContent = '‚è≥ Running...';
      
      const result = await workerCall(action);
      
      if (result.error) {
        showToast(`‚ùå ${action} failed`);
      } else {
        showToast(`‚úÖ ${action} completed`);
        refreshAll();
      }
      
      btn.disabled = false;
      // Re-render to restore button text
      renderActionsWidget('actions');
    });
    
    // ============ AUTH ============
    async function handleEmailLogin(e) {
      e.preventDefault();
      
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      console.log('[Login] Email login:', email);
      
      const { data, error } = await sb.auth.signInWithPassword({
        email,
        password
      });
      
      if (error) {
        console.error('[Login] Error:', error);
        showLoginError(error.message);
      } else {
        console.log('[Login] Success:', data.user?.email);
      }
    }
    
    async function handleGoogleLogin() {
      console.log('[Login] Google login');
      
      const { error } = await sb.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: window.location.origin + window.location.pathname
        }
      });
      
      if (error) {
        console.error('[Login] Error:', error);
        showLoginError(error.message);
      }
    }
    
    async function handleLogout() {
      if (confirm('Sign out?')) {
        await sb.auth.signOut();
        window.location.reload();
      }
    }
    
    function showLoginError(msg) {
      const el = document.getElementById('loginError');
      el.textContent = msg;
      el.style.display = 'block';
    }
    
    // ============ LAYOUT ============
    let saveTimeout;
    function saveLayoutDebounced() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        localStorage.setItem('cortex_v3_layout', JSON.stringify(grid.save(false)));
      }, 500);
    }
    
    function saveLayout() {
      localStorage.setItem('cortex_v3_layout', JSON.stringify(grid.save(false)));
      showToast('‚úÖ Layout saved');
    }
    
    function resetLayout() {
      if (confirm('Reset to default layout?')) {
        localStorage.removeItem('cortex_v3_layout');
        loadLayout(DEFAULT_LAYOUT);
        showToast('‚Ü∫ Layout reset');
      }
    }
    
    function addWidget() {
      const available = Object.entries(WIDGETS)
        .filter(([id]) => !grid.getGridItems().find(el => el.gridstackNode?.id === id))
        .map(([id, w]) => `${id}: ${w.title}`)
        .join('\n');
      
      if (!available) { showToast('All widgets added'); return; }
      
      const id = prompt('Enter widget ID:\n\n' + available);
      if (id && WIDGETS[id]) {
        const w = WIDGETS[id];
        grid.addWidget({
          w: w.minW || 3, h: w.minH || 2,
          minW: w.minW, minH: w.minH,
          id: id,
          content: createWidgetHTML(id, w.title)
        });
        w.render(id);
        showToast(`‚ûï Added ${w.title}`);
      }
    }
    
    function removeWidget(id) {
      const item = grid.getGridItems().find(el => el.gridstackNode?.id === id);
      if (item) { grid.removeWidget(item); showToast('Removed widget'); }
    }
    
    function toggleEditMode() {
      editMode = !editMode;
      document.getElementById('editModeToggle').classList.toggle('active', editMode);
      grid.enableMove(editMode);
      grid.enableResize(editMode);
      showToast(editMode ? '‚úèÔ∏è Edit ON' : 'üîí Locked');
    }
    
    // ============ UTILITIES ============
    function maskId(id) {
      if (!id) return '--';
      return id.substring(0, 6) + '...';
    }
    
    function timeAgo(date) {
      if (!date) return '--';
      const sec = Math.floor((Date.now() - new Date(date)) / 1000);
      if (sec < 60) return 'now';
      if (sec < 3600) return Math.floor(sec / 60) + 'm';
      if (sec < 86400) return Math.floor(sec / 3600) + 'h';
      return Math.floor(sec / 86400) + 'd';
    }
    
    function showToast(msg) {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2500);
    }
    
    // ============ START ============
    init();
  </script>
</body>
</html>
