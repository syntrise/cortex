<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CORTEX v3.1 | Syntrise Admin</title>
  
  <!-- Gridstack.js -->
  <link href="https://cdn.jsdelivr.net/npm/gridstack@10/dist/gridstack.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/gridstack@10/dist/gridstack-all.js"></script>
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  
  <style>
    /* ========== THEME VARIABLES ========== */
    :root {
      /* Light Theme (Claude/Perplexity inspired) */
      --bg-primary: #ffffff;
      --bg-secondary: #f9fafb;
      --bg-tertiary: #f3f4f6;
      --bg-card: #ffffff;
      --bg-card-hover: #f9fafb;
      --border: #e5e7eb;
      --border-hover: #d1d5db;
      --text-primary: #111827;
      --text-secondary: #4b5563;
      --text-muted: #9ca3af;
      --accent: #6366f1;
      --accent-hover: #4f46e5;
      --accent-light: rgba(99, 102, 241, 0.1);
      --blue: #3b82f6;
      --green: #10b981;
      --yellow: #f59e0b;
      --red: #ef4444;
      --purple: #8b5cf6;
      --cyan: #06b6d4;
      --orange: #f97316;
      
      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -1px rgba(0,0,0,0.04);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -2px rgba(0,0,0,0.04);
      
      /* Font sizes */
      --font-xs: 11px;
      --font-sm: 12px;
      --font-base: 13px;
      --font-lg: 14px;
      --font-xl: 16px;
      --font-2xl: 20px;
      --font-3xl: 24px;
    }
    
    /* Size presets */
    [data-size="small"] {
      --font-xs: 10px;
      --font-sm: 11px;
      --font-base: 12px;
      --font-lg: 13px;
      --font-xl: 14px;
      --font-2xl: 18px;
      --font-3xl: 22px;
    }
    
    [data-size="large"] {
      --font-xs: 12px;
      --font-sm: 13px;
      --font-base: 14px;
      --font-lg: 15px;
      --font-xl: 18px;
      --font-2xl: 24px;
      --font-3xl: 28px;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      min-height: 100vh;
      font-size: var(--font-base);
      line-height: 1.5;
    }
    
    /* ========== LOGIN ========== */
    .login-screen {
      position: fixed;
      inset: 0;
      background: var(--bg-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    
    .login-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      text-align: center;
      box-shadow: var(--shadow-lg);
    }
    
    .login-logo {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin: 0 auto 16px;
    }
    
    .login-title {
      font-size: var(--font-2xl);
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--text-primary);
    }
    
    .login-subtitle {
      color: var(--text-muted);
      margin-bottom: 28px;
      font-size: var(--font-sm);
    }
    
    .login-form { margin-bottom: 16px; }
    
    .login-input {
      width: 100%;
      padding: 12px 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text-primary);
      font-size: var(--font-base);
      margin-bottom: 10px;
      transition: all 0.2s;
    }
    
    .login-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }
    
    .login-input::placeholder { color: var(--text-muted); }
    
    .login-btn {
      width: 100%;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: var(--font-base);
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.2s;
      border: none;
      margin-bottom: 8px;
    }
    
    .login-btn-primary {
      background: var(--accent);
      color: white;
    }
    
    .login-btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .login-btn-google {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    
    .login-btn-google:hover {
      background: var(--bg-secondary);
      border-color: var(--border-hover);
    }
    
    .login-divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
      color: var(--text-muted);
      font-size: var(--font-xs);
    }
    
    .login-divider::before,
    .login-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }
    
    .login-divider span { padding: 0 12px; }
    
    .login-error {
      margin-top: 16px;
      padding: 10px 14px;
      background: rgba(239, 68, 68, 0.08);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 8px;
      color: var(--red);
      font-size: var(--font-sm);
      display: none;
    }
    
    /* ========== HEADER ========== */
    .header {
      height: 56px;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-left { display: flex; align-items: center; gap: 16px; }
    .logo { display: flex; align-items: center; gap: 10px; }
    
    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    
    .logo-text { 
      font-size: var(--font-xl); 
      font-weight: 700; 
      color: var(--text-primary);
    }
    
    .version-badge {
      font-size: var(--font-xs);
      color: var(--text-muted);
      background: var(--bg-tertiary);
      padding: 3px 8px;
      border-radius: 6px;
    }
    
    .header-center { display: flex; align-items: center; gap: 6px; }
    
    .header-btn {
      padding: 7px 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: var(--font-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.15s;
    }
    
    .header-btn:hover {
      background: var(--bg-secondary);
      border-color: var(--border-hover);
      color: var(--text-primary);
    }
    
    .header-btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    
    .header-btn.primary:hover { 
      background: var(--accent-hover); 
    }
    
    .header-right { display: flex; align-items: center; gap: 10px; }
    
    .size-selector {
      display: flex;
      background: var(--bg-tertiary);
      border-radius: 6px;
      padding: 2px;
    }
    
    .size-btn {
      padding: 4px 8px;
      border: none;
      background: transparent;
      border-radius: 4px;
      font-size: var(--font-xs);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .size-btn.active {
      background: var(--bg-card);
      color: var(--text-primary);
      box-shadow: var(--shadow-sm);
    }
    
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: var(--font-xs);
      color: var(--text-muted);
    }
    
    .status-dot {
      width: 7px;
      height: 7px;
      background: var(--green);
      border-radius: 50%;
    }
    
    .user-menu {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 10px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .user-menu:hover { background: var(--border); }
    
    .user-avatar {
      width: 26px;
      height: 26px;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-xs);
      font-weight: 600;
      color: white;
    }
    
    .user-email {
      font-size: var(--font-sm);
      color: var(--text-secondary);
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* ========== TOOLBAR ========== */
    .toolbar {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 8px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .toolbar-left { display: flex; align-items: center; gap: 16px; }
    .toolbar-title { font-size: var(--font-sm); color: var(--text-muted); }
    
    .edit-mode-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: var(--font-xs);
      color: var(--text-secondary);
    }
    
    .toggle-switch {
      width: 36px;
      height: 20px;
      background: var(--border);
      border-radius: 10px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .toggle-switch.active { background: var(--accent); }
    
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: transform 0.2s;
      box-shadow: var(--shadow-sm);
    }
    
    .toggle-switch.active::after { transform: translateX(16px); }
    
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: var(--font-xs);
      color: var(--text-muted);
    }
    
    /* ========== MAIN CONTENT ========== */
    .main-content {
      padding: 16px;
      min-height: calc(100vh - 100px);
    }
    
    /* ========== GRIDSTACK ========== */
    .grid-stack { background: transparent; }
    
    .grid-stack-item-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-sm);
      transition: box-shadow 0.2s, border-color 0.2s;
    }
    
    .grid-stack-item-content:hover { 
      border-color: var(--border-hover);
      box-shadow: var(--shadow-md);
    }
    
    .gs-item-dragging .grid-stack-item-content {
      box-shadow: var(--shadow-lg);
      border-color: var(--accent);
    }
    
    /* ========== WIDGET COMMON ========== */
    .widget-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-secondary);
      cursor: move;
      flex-shrink: 0;
    }
    
    .widget-title {
      font-size: var(--font-sm);
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .widget-badge {
      font-size: var(--font-xs);
      padding: 2px 6px;
      background: var(--accent-light);
      border-radius: 4px;
      color: var(--accent);
      font-weight: 500;
    }
    
    .widget-actions { display: flex; gap: 2px; }
    
    .widget-action {
      width: 28px;
      height: 28px;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-base);
      transition: all 0.15s;
    }
    
    .widget-action:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .widget-body { 
      padding: 16px; 
      flex: 1; 
      overflow: auto;
      min-height: 0;
    }
    
    .widget-body.no-padding { padding: 0; }
    
    /* ========== KPI CARDS ========== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 12px;
      height: 100%;
    }
    
    .kpi-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      transition: all 0.2s;
    }
    
    .kpi-card:hover {
      border-color: var(--border-hover);
      box-shadow: var(--shadow-sm);
    }
    
    .kpi-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-xl);
      margin-bottom: 10px;
    }
    
    .kpi-icon.blue { background: rgba(59, 130, 246, 0.1); }
    .kpi-icon.green { background: rgba(16, 185, 129, 0.1); }
    .kpi-icon.yellow { background: rgba(245, 158, 11, 0.1); }
    .kpi-icon.purple { background: rgba(139, 92, 246, 0.1); }
    .kpi-icon.cyan { background: rgba(6, 182, 212, 0.1); }
    .kpi-icon.red { background: rgba(239, 68, 68, 0.1); }
    
    .kpi-label {
      font-size: var(--font-xs);
      color: var(--text-muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }
    
    .kpi-value { 
      font-size: var(--font-2xl); 
      font-weight: 700; 
      line-height: 1.1; 
      color: var(--text-primary);
    }
    
    .kpi-change {
      margin-top: auto;
      padding-top: 8px;
      font-size: var(--font-xs);
      color: var(--text-muted);
    }
    
    .kpi-change.positive { color: var(--green); }
    .kpi-change.negative { color: var(--red); }
    
    /* ========== HEALTH LIST ========== */
    .health-list { display: flex; flex-direction: column; gap: 8px; }
    
    .health-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    
    .health-name { font-size: var(--font-sm); color: var(--text-secondary); }
    
    .health-right { display: flex; align-items: center; gap: 8px; }
    
    .health-status {
      font-size: var(--font-xs);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .health-status.ok { color: var(--green); }
    .health-status.warn { color: var(--yellow); }
    .health-status.error { color: var(--red); }
    .health-status.checking { color: var(--text-muted); }
    
    .health-latency { font-size: var(--font-xs); color: var(--text-muted); }
    
    /* ========== PROVIDERS ========== */
    .providers-grid { display: flex; flex-direction: column; gap: 10px; }
    
    .provider-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
    }
    
    .provider-card.healthy { border-color: rgba(16, 185, 129, 0.3); }
    .provider-card.warning { border-color: rgba(245, 158, 11, 0.3); }
    
    .provider-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .provider-name { font-size: var(--font-sm); font-weight: 600; }
    
    .provider-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .provider-status-dot.healthy { background: var(--green); }
    .provider-status-dot.warning { background: var(--yellow); }
    
    .provider-stats { display: flex; flex-direction: column; gap: 6px; }
    
    .provider-stat {
      display: flex;
      justify-content: space-between;
      font-size: var(--font-xs);
    }
    
    .provider-stat .label { color: var(--text-muted); }
    .provider-stat .value { color: var(--text-secondary); }
    .provider-stat .cost { color: var(--purple); font-weight: 600; }
    
    .provider-bar {
      height: 3px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 8px;
      overflow: hidden;
    }
    
    .provider-bar-fill {
      height: 100%;
      background: var(--green);
      border-radius: 2px;
    }
    
    /* ========== USERS TABLE ========== */
    .search-box { position: relative; margin-bottom: 12px; }
    
    .search-input {
      width: 100%;
      padding: 10px 12px 10px 36px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: var(--font-sm);
      transition: all 0.15s;
    }
    
    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }
    
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: var(--font-base);
    }
    
    .filter-chips { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
    
    .filter-chip {
      padding: 5px 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: var(--font-xs);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .filter-chip:hover, .filter-chip.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    
    .users-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--font-sm);
    }
    
    .users-table th {
      text-align: left;
      padding: 8px 10px;
      font-size: var(--font-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      background: var(--bg-card);
      position: sticky;
      top: 0;
    }
    
    .users-table td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
    }
    
    .users-table tr { cursor: pointer; transition: background 0.1s; }
    .users-table tbody tr:hover { background: var(--bg-secondary); }
    .users-table tbody tr.selected { background: var(--accent-light); }
    
    .user-id-cell {
      font-family: 'SF Mono', 'Menlo', monospace;
      font-size: var(--font-xs);
      color: var(--accent);
    }
    
    .tier-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: var(--font-xs);
      font-weight: 600;
    }
    
    .tier-badge.owner { background: rgba(139, 92, 246, 0.15); color: var(--purple); }
    .tier-badge.family { background: rgba(16, 185, 129, 0.15); color: var(--green); }
    .tier-badge.beta { background: rgba(59, 130, 246, 0.15); color: var(--blue); }
    .tier-badge.free { background: var(--bg-tertiary); color: var(--text-muted); }
    
    /* ========== USER 360 ========== */
    .user-360-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      text-align: center;
    }
    
    .user-360-empty-icon { font-size: 40px; margin-bottom: 10px; opacity: 0.4; }
    
    .user-360-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 12px;
    }
    
    .user-360-avatar {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-xl);
      color: white;
    }
    
    .user-360-info { flex: 1; }
    .user-360-id { font-size: var(--font-lg); font-weight: 600; }
    .user-360-tier { font-size: var(--font-xs); color: var(--text-muted); }
    
    .user-360-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .stat-card { 
      background: var(--bg-secondary); 
      border-radius: 8px; 
      padding: 10px;
      border: 1px solid var(--border);
    }
    .stat-label { font-size: var(--font-xs); color: var(--text-muted); margin-bottom: 2px; }
    .stat-value { font-size: var(--font-lg); font-weight: 600; }
    
    .user-360-breakdown {
      margin-bottom: 12px;
    }
    
    .breakdown-title {
      font-size: var(--font-xs);
      color: var(--text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .breakdown-items { display: flex; flex-direction: column; gap: 6px; }
    
    .breakdown-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: var(--font-sm);
    }
    
    .breakdown-row .icon { width: 20px; text-align: center; }
    .breakdown-row .name { flex: 1; color: var(--text-secondary); }
    .breakdown-row .count { font-weight: 600; color: var(--text-primary); }
    
    .user-360-actions { display: flex; gap: 6px; flex-wrap: wrap; }
    
    .action-btn {
      padding: 7px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: var(--font-xs);
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .action-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-hover);
      color: var(--text-primary);
    }
    
    .action-btn.danger { 
      color: var(--red); 
      border-color: rgba(239, 68, 68, 0.3); 
    }
    
    .action-btn.danger:hover { 
      background: rgba(239, 68, 68, 0.08); 
    }
    
    /* ========== COMMANDS TABLE ========== */
    .commands-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--font-sm);
    }
    
    .commands-table th {
      text-align: left;
      padding: 8px 10px;
      font-size: var(--font-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.4px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      background: var(--bg-card);
      position: sticky;
      top: 0;
    }
    
    .commands-table td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
    }
    
    .commands-table tr:hover { background: var(--bg-secondary); }
    
    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: var(--font-xs);
      font-weight: 500;
    }
    
    .status-badge.pending { background: rgba(245, 158, 11, 0.15); color: var(--yellow); }
    .status-badge.completed { background: rgba(16, 185, 129, 0.15); color: var(--green); }
    .status-badge.failed { background: rgba(239, 68, 68, 0.15); color: var(--red); }
    
    /* ========== TESTERS ========== */
    .testers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
    }
    
    .tester-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
    }
    
    .tester-card.active { border-color: rgba(16, 185, 129, 0.3); }
    
    .tester-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .tester-avatar {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-sm);
      font-weight: 600;
      color: white;
    }
    
    .tester-status {
      font-size: var(--font-xs);
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .tester-status.online { background: rgba(16, 185, 129, 0.15); color: var(--green); }
    .tester-status.recent { background: rgba(59, 130, 246, 0.15); color: var(--blue); }
    .tester-status.offline { background: var(--bg-tertiary); color: var(--text-muted); }
    
    .tester-name { font-size: var(--font-sm); font-weight: 600; margin-bottom: 2px; }
    .tester-tier { font-size: var(--font-xs); color: var(--text-muted); }
    
    .tester-stats {
      display: flex;
      gap: 12px;
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
    }
    
    .tester-stat { text-align: center; }
    .tester-stat-value { font-size: var(--font-lg); font-weight: 600; }
    .tester-stat-label { font-size: 9px; color: var(--text-muted); text-transform: uppercase; }
    
    /* ========== TIMELINE ========== */
    .timeline { display: flex; flex-direction: column; gap: 6px; }
    
    .timeline-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      background: var(--bg-secondary);
      border-radius: 8px;
      font-size: var(--font-sm);
      border: 1px solid var(--border);
    }
    
    .timeline-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .timeline-dot.drop { background: var(--blue); }
    .timeline-dot.command { background: var(--purple); }
    
    .timeline-content { flex: 1; min-width: 0; }
    .timeline-text { color: var(--text-secondary); }
    .timeline-time { font-size: var(--font-xs); color: var(--text-muted); flex-shrink: 0; }
    
    /* ========== HOURLY CHART ========== */
    .hourly-chart {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 100%;
      min-height: 80px;
    }
    
    .hourly-bar {
      flex: 1;
      background: linear-gradient(to top, var(--accent), var(--purple));
      border-radius: 2px 2px 0 0;
      min-height: 3px;
      transition: all 0.3s;
      opacity: 0.8;
    }
    
    .hourly-bar:hover { opacity: 1; }
    
    /* ========== BREAKDOWN ========== */
    .breakdown-list { display: flex; flex-direction: column; gap: 10px; }
    
    .breakdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .breakdown-icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-base);
      background: var(--bg-secondary);
      border: 1px solid var(--border);
    }
    
    .breakdown-info { flex: 1; }
    .breakdown-name { font-size: var(--font-sm); color: var(--text-secondary); }
    
    .breakdown-bar {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 4px;
      overflow: hidden;
    }
    
    .breakdown-bar-fill {
      height: 100%;
      border-radius: 2px;
    }
    
    .breakdown-count {
      font-size: var(--font-base);
      font-weight: 600;
      color: var(--text-primary);
    }
    
    /* ========== QUICK ACTIONS ========== */
    .quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .quick-btn {
      padding: 8px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: var(--font-sm);
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .quick-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--border-hover);
      color: var(--text-primary);
    }
    
    .quick-btn.danger {
      color: var(--red);
      border-color: rgba(239, 68, 68, 0.3);
    }
    
    .quick-btn.danger:hover {
      background: rgba(239, 68, 68, 0.08);
    }
    
    /* ========== ALERTS ========== */
    .alerts-list { display: flex; flex-direction: column; gap: 8px; }
    
    .alert-item {
      display: flex;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      border-left: 3px solid;
    }
    
    .alert-item.critical { border-left-color: var(--red); }
    .alert-item.warning { border-left-color: var(--yellow); }
    .alert-item.info { border-left-color: var(--blue); }
    
    .alert-icon { font-size: var(--font-xl); flex-shrink: 0; }
    .alert-content { flex: 1; min-width: 0; }
    .alert-title { font-size: var(--font-sm); font-weight: 500; margin-bottom: 2px; }
    .alert-desc { font-size: var(--font-xs); color: var(--text-muted); }
    .alert-time { font-size: var(--font-xs); color: var(--text-muted); flex-shrink: 0; }
    
    /* ========== LOADING & EMPTY ========== */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      min-height: 60px;
      color: var(--text-muted);
      font-size: var(--font-sm);
    }
    
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      min-height: 80px;
      color: var(--text-muted);
      text-align: center;
    }
    
    .empty-state-icon { font-size: 28px; margin-bottom: 8px; opacity: 0.4; }
    .empty-state-text { font-size: var(--font-sm); }
    
    /* ========== TOAST ========== */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 12px 16px;
      border-radius: 10px;
      font-size: var(--font-sm);
      z-index: 1000;
      animation: slideIn 0.3s ease;
      box-shadow: var(--shadow-lg);
    }
    
    @keyframes slideIn {
      from { transform: translateY(16px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    /* ========== RESPONSIVE ========== */
    @media (max-width: 1200px) {
      .kpi-grid { grid-template-columns: repeat(3, 1fr); }
    }
    
    @media (max-width: 768px) {
      .header { padding: 0 12px; }
      .header-center { display: none; }
      .main-content { padding: 10px; }
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body data-size="normal">
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-card">
      <div class="login-logo">üß†</div>
      <h1 class="login-title">CORTEX</h1>
      <p class="login-subtitle">Syntrise Admin Dashboard</p>
      
      <form class="login-form" id="loginForm">
        <input type="email" class="login-input" id="loginEmail" placeholder="Email" required>
        <input type="password" class="login-input" id="loginPassword" placeholder="Password" required>
        <button type="submit" class="login-btn login-btn-primary">Sign In</button>
      </form>
      
      <div class="login-divider"><span>or</span></div>
      
      <button class="login-btn login-btn-google" id="googleLoginBtn">
        <svg width="18" height="18" viewBox="0 0 18 18">
          <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
          <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/>
          <path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/>
          <path fill="#EA4335" d="M8.98 3.58c1.16 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.9z"/>
        </svg>
        Sign in with Google
      </button>
      
      <div class="login-error" id="loginError"></div>
    </div>
  </div>

  <!-- Main App -->
  <div id="app" style="display: none;">
    <header class="header">
      <div class="header-left">
        <div class="logo">
          <div class="logo-icon">üß†</div>
          <span class="logo-text">CORTEX</span>
        </div>
        <span class="version-badge">v3.1</span>
      </div>
      
      <div class="header-center">
        <button class="header-btn" id="healthCheckBtn">‚ö° Health</button>
        <button class="header-btn" id="addWidgetBtn">+ Widget</button>
        <button class="header-btn" id="resetLayoutBtn">‚Ü∫ Reset</button>
        <button class="header-btn primary" id="saveLayoutBtn">üíæ Save</button>
      </div>
      
      <div class="header-right">
        <div class="size-selector">
          <button class="size-btn" data-size="small">S</button>
          <button class="size-btn active" data-size="normal">M</button>
          <button class="size-btn" data-size="large">L</button>
        </div>
        <div class="status-indicator">
          <span class="status-dot" id="connectionDot"></span>
          <span id="connectionStatus">Live</span>
        </div>
        <div class="user-menu" id="userMenu">
          <div class="user-avatar" id="userAvatar">?</div>
          <span class="user-email" id="userEmail">...</span>
        </div>
      </div>
    </header>
    
    <div class="toolbar">
      <div class="toolbar-left">
        <span class="toolbar-title">Drag widgets to customize layout</span>
        <div class="edit-mode-toggle">
          <span>Edit</span>
          <div class="toggle-switch active" id="editModeToggle"></div>
        </div>
      </div>
      <div class="toolbar-right">
        <span>Updated: <span id="lastRefresh">--</span></span>
        <button class="header-btn" id="refreshBtn">üîÑ</button>
      </div>
    </div>
    
    <main class="main-content">
      <div class="grid-stack" id="grid"></div>
    </main>
  </div>

  <script>
    // ============ CONFIG ============
    const SUPABASE_URL = 'https://ughfdhmyflotgsysvrrc.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnaGZkaG15ZmxvdGdzeXN2cnJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NDgwMTEsImV4cCI6MjA4MjQyNDAxMX0.s6oAvyk6gJU0gcJV00HxPnxkvWIbhF2I3pVnPMNVcrE';
    
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // ============ STATE ============
    let currentUser = null;
    let grid = null;
    let editMode = true;
    let selectedUserId = null;
    
    const cache = {
      drops: [],
      commands: [],
      users: [],
      apiCosts: [],
      embeddings: 0,
      totalDrops: 0,
      totalCommands: 0
    };
    
    // ============ LAYOUT ============
    const DEFAULT_LAYOUT = [
      { x: 0, y: 0, w: 12, h: 2, id: 'kpi' },
      { x: 0, y: 2, w: 3, h: 4, id: 'health' },
      { x: 3, y: 2, w: 3, h: 4, id: 'providers' },
      { x: 6, y: 2, w: 3, h: 4, id: 'breakdown' },
      { x: 9, y: 2, w: 3, h: 4, id: 'user360' },
      { x: 0, y: 6, w: 5, h: 4, id: 'users' },
      { x: 5, y: 6, w: 4, h: 4, id: 'commands' },
      { x: 9, y: 6, w: 3, h: 4, id: 'testers' },
      { x: 0, y: 10, w: 3, h: 3, id: 'hourly' },
      { x: 3, y: 10, w: 3, h: 3, id: 'timeline' },
      { x: 6, y: 10, w: 3, h: 3, id: 'alerts' },
      { x: 9, y: 10, w: 3, h: 3, id: 'actions' }
    ];
    
    // ============ WIDGETS ============
    const WIDGETS = {
      kpi: { title: 'üìä Overview', minW: 4, minH: 2, render: renderKPIWidget },
      health: { title: 'üíö System Health', minW: 2, minH: 2, render: renderHealthWidget },
      providers: { title: 'ü§ñ AI Providers', minW: 2, minH: 3, render: renderProvidersWidget },
      breakdown: { title: 'üì¶ Drops by Type', minW: 2, minH: 2, render: renderBreakdownWidget },
      users: { title: 'üë• Users', minW: 3, minH: 3, render: renderUsersWidget },
      user360: { title: 'üë§ User 360¬∞', minW: 2, minH: 3, render: renderUser360Widget },
      commands: { title: '‚ö° Commands', minW: 3, minH: 3, render: renderCommandsWidget },
      testers: { title: 'üß™ Testers', minW: 2, minH: 3, render: renderTestersWidget },
      hourly: { title: 'üìà 24h Activity', minW: 2, minH: 2, render: renderHourlyWidget },
      timeline: { title: 'üïê Feed', minW: 2, minH: 2, render: renderTimelineWidget },
      alerts: { title: 'üö® Alerts', minW: 2, minH: 2, render: renderAlertsWidget },
      actions: { title: '‚ö° Actions', minW: 2, minH: 2, render: renderActionsWidget }
    };
    
    // ============ API ============
    async function query(path) {
      const start = Date.now();
      try {
        const session = (await sb.auth.getSession()).data.session;
        const token = session?.access_token || SUPABASE_KEY;
        
        const response = await fetch(`${SUPABASE_URL}/rest/v1/${path}`, {
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${token}`
          }
        });
        
        if (!response.ok) return { data: null, latency: Date.now() - start, error: response.statusText };
        
        const data = await response.json();
        return { data, latency: Date.now() - start, error: null };
      } catch (error) {
        return { data: null, latency: Date.now() - start, error };
      }
    }
    
    async function queryCount(table) {
      try {
        const session = (await sb.auth.getSession()).data.session;
        const token = session?.access_token || SUPABASE_KEY;
        
        const separator = table.includes('?') ? '&' : '?';
        const response = await fetch(`${SUPABASE_URL}/rest/v1/${table}${separator}select=id`, {
          method: 'HEAD',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${token}`,
            'Prefer': 'count=exact'
          }
        });
        
        return parseInt(response.headers.get('content-range')?.split('/')[1] || '0');
      } catch (e) {
        return 0;
      }
    }
    
    async function workerCall(action) {
      const start = Date.now();
      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/core-worker`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_KEY}`
          },
          body: JSON.stringify({ action })
        });
        const data = await response.json();
        return { data, latency: Date.now() - start, error: null };
      } catch (error) {
        return { data: null, latency: Date.now() - start, error };
      }
    }
    
    // ============ INIT ============
    async function init() {
      document.getElementById('loginForm').addEventListener('submit', handleEmailLogin);
      document.getElementById('googleLoginBtn').addEventListener('click', handleGoogleLogin);
      document.getElementById('healthCheckBtn').addEventListener('click', healthCheck);
      document.getElementById('addWidgetBtn').addEventListener('click', addWidget);
      document.getElementById('resetLayoutBtn').addEventListener('click', resetLayout);
      document.getElementById('saveLayoutBtn').addEventListener('click', saveLayout);
      document.getElementById('editModeToggle').addEventListener('click', toggleEditMode);
      document.getElementById('refreshBtn').addEventListener('click', refreshAll);
      document.getElementById('userMenu').addEventListener('click', handleLogout);
      
      // Size selector
      document.querySelectorAll('.size-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.body.dataset.size = btn.dataset.size;
          localStorage.setItem('cortex_size', btn.dataset.size);
        });
      });
      
      // Restore size
      const savedSize = localStorage.getItem('cortex_size') || 'normal';
      document.body.dataset.size = savedSize;
      document.querySelector(`[data-size="${savedSize}"]`)?.classList.add('active');
      
      const { data: { session } } = await sb.auth.getSession();
      if (session?.user) await verifyAccess(session);
      
      sb.auth.onAuthStateChange(async (event, session) => {
        if (event === 'SIGNED_IN' && session?.user) await verifyAccess(session);
      });
    }
    
    async function verifyAccess(session) {
      try {
        const { data: limits } = await sb
          .from('user_limits')
          .select('tier')
          .eq('user_id', session.user.id)
          .single();
        
        if (limits?.tier === 'owner') {
          currentUser = session.user;
          if (window.location.hash) history.replaceState(null, '', window.location.pathname);
          showApp();
        } else {
          await sb.auth.signOut();
          showLoginError('Access denied. Owner required.');
        }
      } catch (e) {
        showLoginError('Error verifying access.');
      }
    }
    
    function showApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('userEmail').textContent = currentUser.email;
      document.getElementById('userAvatar').textContent = currentUser.email.charAt(0).toUpperCase();
      
      initGrid();
      refreshAll();
      setInterval(refreshAll, 30000);
    }
    
    function initGrid() {
      grid = GridStack.init({
        column: 12,
        cellHeight: 70,
        margin: 8,
        float: false,
        animate: true,
        draggable: { handle: '.widget-header' },
        resizable: { handles: 'se, sw, e, w' }
      });
      
      const saved = localStorage.getItem('cortex_v3_layout');
      loadLayout(saved ? JSON.parse(saved) : DEFAULT_LAYOUT);
      grid.on('change', () => {
        clearTimeout(window.saveTimeout);
        window.saveTimeout = setTimeout(() => {
          localStorage.setItem('cortex_v3_layout', JSON.stringify(grid.save(false)));
        }, 500);
      });
    }
    
    function loadLayout(layout) {
      grid.removeAll();
      layout.forEach(item => {
        const w = WIDGETS[item.id];
        if (!w) return;
        grid.addWidget({
          x: item.x, y: item.y, w: item.w, h: item.h,
          minW: w.minW, minH: w.minH, id: item.id,
          content: `
            <div class="widget-header">
              <span class="widget-title">${w.title}</span>
              <div class="widget-actions">
                <button class="widget-action" data-action="refresh" data-id="${item.id}">üîÑ</button>
                <button class="widget-action" data-action="remove" data-id="${item.id}">‚úï</button>
              </div>
            </div>
            <div class="widget-body" id="body-${item.id}"><div class="loading">Loading...</div></div>
          `
        });
        w.render(item.id);
      });
    }
    
    // Widget actions delegation
    document.addEventListener('click', function(e) {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;
      const { action, id } = btn.dataset;
      if (action === 'refresh') WIDGETS[id]?.render(id);
      if (action === 'remove') {
        const item = grid.getGridItems().find(el => el.gridstackNode?.id === id);
        if (item) grid.removeWidget(item);
      }
    });
    
    // ============ DATA ============
    async function refreshAll() {
      document.getElementById('lastRefresh').textContent = new Date().toLocaleTimeString();
      
      try {
        cache.totalDrops = await queryCount('drops');
        cache.totalCommands = await queryCount('drops?drop_group=eq.command');
        
        const [drops, commands, limits, costs] = await Promise.all([
          query('drops?select=id,user_id,category,drop_group,created_at&order=created_at.desc&limit=500'),
          query('drops?drop_group=eq.command&select=id,user_id,drop_type,exec_status,created_at&order=created_at.desc&limit=100'),
          query('user_limits?select=user_id,tier'),
          query('api_costs?select=id,provider,model,cost_usd,tokens_input,tokens_output,created_at')
        ]);
        
        cache.drops = Array.isArray(drops.data) ? drops.data : [];
        cache.commands = Array.isArray(commands.data) ? commands.data : [];
        cache.users = Array.isArray(limits.data) ? limits.data : [];
        cache.apiCosts = Array.isArray(costs.data) ? costs.data : [];
        cache.embeddings = await queryCount('drop_embeddings');
        
        Object.keys(WIDGETS).forEach(id => {
          if (document.getElementById(`body-${id}`)) WIDGETS[id].render(id);
        });
        
        document.getElementById('connectionDot').style.background = 'var(--green)';
        document.getElementById('connectionStatus').textContent = 'Live';
      } catch (e) {
        document.getElementById('connectionDot').style.background = 'var(--red)';
        document.getElementById('connectionStatus').textContent = 'Offline';
      }
    }
    
    // ============ RENDERERS ============
    function renderKPIWidget(id) {
      const body = document.getElementById(`body-${id}`);
      const today = new Date().toISOString().split('T')[0];
      const todayDrops = cache.drops.filter(d => d.created_at?.startsWith(today)).length;
      const uniqueUsers = [...new Set(cache.drops.map(d => d.user_id).filter(Boolean))].length;
      const pendingCommands = cache.commands.filter(c => c.exec_status === 'pending').length;
      const totalCost = cache.apiCosts.reduce((sum, c) => sum + (parseFloat(c.cost_usd) || 0), 0);
      
      body.innerHTML = `
        <div class="kpi-grid">
          <div class="kpi-card"><div class="kpi-icon blue">üìù</div><div class="kpi-label">Total Drops</div><div class="kpi-value">${cache.totalDrops.toLocaleString()}</div><div class="kpi-change">All time</div></div>
          <div class="kpi-card"><div class="kpi-icon green">üìÖ</div><div class="kpi-label">Today</div><div class="kpi-value">${todayDrops}</div><div class="kpi-change">New drops</div></div>
          <div class="kpi-card"><div class="kpi-icon cyan">üë•</div><div class="kpi-label">Users</div><div class="kpi-value">${uniqueUsers}</div><div class="kpi-change">${cache.users.length} registered</div></div>
          <div class="kpi-card"><div class="kpi-icon yellow">‚ö°</div><div class="kpi-label">Commands</div><div class="kpi-value">${cache.totalCommands}</div><div class="kpi-change">${pendingCommands} pending</div></div>
          <div class="kpi-card"><div class="kpi-icon purple">üß†</div><div class="kpi-label">Embeddings</div><div class="kpi-value">${cache.embeddings.toLocaleString()}</div><div class="kpi-change">Vectors</div></div>
          <div class="kpi-card"><div class="kpi-icon red">üí∞</div><div class="kpi-label">API Costs</div><div class="kpi-value">$${totalCost.toFixed(2)}</div><div class="kpi-change">Total</div></div>
        </div>
      `;
    }
    
    function renderHealthWidget(id) {
      const body = document.getElementById(`body-${id}`);
      body.innerHTML = `
        <div class="health-list">
          <div class="health-item"><span class="health-name">üóÑÔ∏è Supabase</span><div class="health-right"><span class="health-status checking" id="health-supabase">‚è≥</span><span class="health-latency" id="latency-supabase"></span></div></div>
          <div class="health-item"><span class="health-name">‚öôÔ∏è Worker</span><div class="health-right"><span class="health-status checking" id="health-worker">‚è≥</span><span class="health-latency" id="latency-worker"></span></div></div>
          <div class="health-item"><span class="health-name">ü§ñ Claude</span><div class="health-right"><span class="health-status checking" id="health-claude">‚è≥</span></div></div>
          <div class="health-item"><span class="health-name">üß† Embeddings</span><div class="health-right"><span class="health-status checking" id="health-embeddings">‚è≥</span></div></div>
        </div>
      `;
      healthCheck();
    }
    
    async function healthCheck() {
      const update = (svc, ok, latency) => {
        const el = document.getElementById(`health-${svc}`);
        const lat = document.getElementById(`latency-${svc}`);
        if (el) { el.textContent = ok ? '‚óè' : '‚óã'; el.className = `health-status ${ok ? 'ok' : 'error'}`; }
        if (lat && latency) lat.textContent = `${latency}ms`;
      };
      
      const db = await query('drops?select=id&limit=1');
      update('supabase', !db.error, db.latency);
      
      const worker = await workerCall('ping');
      update('worker', !worker.error && worker.data?.success, worker.latency);
      
      const claude = await workerCall('health_check');
      update('claude', claude.data?.claude === 'ok');
      
      update('embeddings', cache.embeddings > 0);
    }
    
    function renderProvidersWidget(id) {
      const body = document.getElementById(`body-${id}`);
      const byProvider = {};
      cache.apiCosts.forEach(c => {
        const p = c.provider || 'unknown';
        if (!byProvider[p]) byProvider[p] = { requests: 0, cost: 0, tokens: 0 };
        byProvider[p].requests++;
        byProvider[p].cost += parseFloat(c.cost_usd) || 0;
        byProvider[p].tokens += (c.tokens_input || 0) + (c.tokens_output || 0);
      });
      
      const anthropic = byProvider['anthropic'] || { requests: 0, cost: 0, tokens: 0 };
      const openaiCost = (cache.embeddings * 0.00002).toFixed(4);
      const elevenlabs = byProvider['elevenlabs'] || { requests: 0, cost: 0 };
      
      body.innerHTML = `
        <div class="providers-grid">
          <div class="provider-card healthy">
            <div class="provider-header"><span class="provider-name">üü£ Claude</span><span class="provider-status-dot healthy"></span></div>
            <div class="provider-stats">
              <div class="provider-stat"><span class="label">Requests</span><span class="value">${anthropic.requests}</span></div>
              <div class="provider-stat"><span class="label">Tokens</span><span class="value">${(anthropic.tokens / 1000000).toFixed(2)}M</span></div>
              <div class="provider-stat"><span class="label">Cost</span><span class="cost">$${anthropic.cost.toFixed(2)}</span></div>
            </div>
          </div>
          <div class="provider-card healthy">
            <div class="provider-header"><span class="provider-name">üü¢ OpenAI</span><span class="provider-status-dot healthy"></span></div>
            <div class="provider-stats">
              <div class="provider-stat"><span class="label">Embeddings</span><span class="value">${cache.embeddings.toLocaleString()}</span></div>
              <div class="provider-stat"><span class="label">Est. Cost</span><span class="cost">~$${openaiCost}</span></div>
            </div>
          </div>
          <div class="provider-card ${elevenlabs.requests > 0 ? 'healthy' : 'warning'}">
            <div class="provider-header"><span class="provider-name">üîä ElevenLabs</span><span class="provider-status-dot ${elevenlabs.requests > 0 ? 'healthy' : 'warning'}"></span></div>
            <div class="provider-stats">
              <div class="provider-stat"><span class="label">Requests</span><span class="value">${elevenlabs.requests || '‚Äî'}</span></div>
              <div class="provider-stat"><span class="label">Cost</span><span class="cost">${elevenlabs.cost ? '$' + elevenlabs.cost.toFixed(2) : '‚Äî'}</span></div>
            </div>
          </div>
        </div>
      `;
    }
    
    function renderBreakdownWidget(id) {
      const body = document.getElementById(`body-${id}`);
      const byCategory = {};
      cache.drops.forEach(d => {
        const cat = d.category || 'other';
        byCategory[cat] = (byCategory[cat] || 0) + 1;
      });
      
      const sorted = Object.entries(byCategory).sort((a, b) => b[1] - a[1]);
      const max = Math.max(...Object.values(byCategory), 1);
      const colors = { note: '#3b82f6', thought: '#8b5cf6', idea: '#10b981', memory: '#06b6d4', command: '#f59e0b', other: '#9ca3af' };
      const icons = { note: 'üìù', thought: 'üí≠', idea: 'üí°', memory: 'üß†', command: '‚ö°', other: 'üì¶' };
      
      body.innerHTML = `<div class="breakdown-list">${sorted.slice(0, 6).map(([cat, count]) => `
        <div class="breakdown-item">
          <div class="breakdown-icon">${icons[cat] || 'üì¶'}</div>
          <div class="breakdown-info">
            <div class="breakdown-name">${cat}</div>
            <div class="breakdown-bar"><div class="breakdown-bar-fill" style="width:${count/max*100}%;background:${colors[cat] || '#9ca3af'}"></div></div>
          </div>
          <div class="breakdown-count">${count}</div>
        </div>
      `).join('')}</div>`;
    }
    
    function renderUsersWidget(id) {
      const body = document.getElementById(`body-${id}`);
      body.classList.add('no-padding');
      
      // Count drops per user
      const dropsByUser = {};
      cache.drops.forEach(d => {
        if (d.user_id) dropsByUser[d.user_id] = (dropsByUser[d.user_id] || 0) + 1;
      });
      
      body.innerHTML = `
        <div style="padding: 12px;">
          <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" id="userSearch" placeholder="Search users...">
          </div>
          <div class="filter-chips">
            <span class="filter-chip active" data-tier="all">All</span>
            <span class="filter-chip" data-tier="owner">üëë Owner</span>
            <span class="filter-chip" data-tier="family">üë®‚Äçüë©‚Äçüëß Family</span>
            <span class="filter-chip" data-tier="beta">üß™ Beta</span>
            <span class="filter-chip" data-tier="free">Free</span>
          </div>
        </div>
        <div style="overflow:auto;flex:1;">
          <table class="users-table">
            <thead><tr><th>User</th><th>Tier</th><th>Drops</th></tr></thead>
            <tbody id="usersTableBody">
              ${cache.users.map(u => `
                <tr data-uid="${u.user_id}" class="${selectedUserId === u.user_id ? 'selected' : ''}">
                  <td><span class="user-id-cell">${maskId(u.user_id)}</span></td>
                  <td><span class="tier-badge ${u.tier}">${u.tier}</span></td>
                  <td>${dropsByUser[u.user_id] || 0}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      // Search
      document.getElementById('userSearch')?.addEventListener('input', e => {
        const q = e.target.value.toLowerCase();
        document.querySelectorAll('#usersTableBody tr').forEach(tr => {
          tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
        });
      });
      
      // Filter chips
      body.querySelectorAll('.filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          body.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          const tier = chip.dataset.tier;
          document.querySelectorAll('#usersTableBody tr').forEach(tr => {
            if (tier === 'all') tr.style.display = '';
            else tr.style.display = tr.querySelector('.tier-badge')?.classList.contains(tier) ? '' : 'none';
          });
        });
      });
    }
    
    // User row click
    document.addEventListener('click', e => {
      const row = e.target.closest('tr[data-uid]');
      if (row) {
        selectedUserId = row.dataset.uid;
        document.querySelectorAll('#usersTableBody tr').forEach(r => r.classList.remove('selected'));
        row.classList.add('selected');
        renderUser360Widget('user360');
      }
    });
    
    function renderUser360Widget(id) {
      const body = document.getElementById(`body-${id}`);
      
      if (!selectedUserId) {
        body.innerHTML = `<div class="user-360-empty"><div class="user-360-empty-icon">üë§</div><p>Select a user from the table</p></div>`;
        return;
      }
      
      const user = cache.users.find(u => u.user_id === selectedUserId);
      const userDrops = cache.drops.filter(d => d.user_id === selectedUserId);
      const userCommands = cache.commands.filter(c => c.user_id === selectedUserId);
      
      // Category breakdown
      const byCategory = {};
      userDrops.forEach(d => {
        const cat = d.category || 'other';
        byCategory[cat] = (byCategory[cat] || 0) + 1;
      });
      const icons = { note: 'üìù', thought: 'üí≠', idea: 'üí°', memory: 'üß†', command: '‚ö°', other: 'üì¶' };
      
      body.innerHTML = `
        <div class="user-360-header">
          <div class="user-360-avatar">${selectedUserId[0].toUpperCase()}</div>
          <div class="user-360-info">
            <div class="user-360-id">${maskId(selectedUserId)}</div>
            <div class="user-360-tier">${user?.tier || 'unknown'}</div>
          </div>
          <span class="tier-badge ${user?.tier}">${user?.tier}</span>
        </div>
        
        <div class="user-360-stats">
          <div class="stat-card"><div class="stat-label">Drops</div><div class="stat-value">${userDrops.length}</div></div>
          <div class="stat-card"><div class="stat-label">Commands</div><div class="stat-value">${userCommands.length}</div></div>
        </div>
        
        <div class="user-360-breakdown">
          <div class="breakdown-title">By Category</div>
          <div class="breakdown-items">
            ${Object.entries(byCategory).sort((a,b) => b[1] - a[1]).slice(0,5).map(([cat, count]) => `
              <div class="breakdown-row">
                <span class="icon">${icons[cat] || 'üì¶'}</span>
                <span class="name">${cat}</span>
                <span class="count">${count}</span>
              </div>
            `).join('') || '<div style="color:var(--text-muted);font-size:var(--font-sm)">No drops yet</div>'}
          </div>
        </div>
        
        <div class="user-360-actions">
          <button class="action-btn" onclick="showToast('View drops: ${maskId(selectedUserId)}')">üìù View Drops</button>
          <button class="action-btn" onclick="showToast('Change tier')">üè∑Ô∏è Change Tier</button>
          <button class="action-btn danger" onclick="if(confirm('Ban user?')) showToast('Banned')">üö´ Ban</button>
        </div>
      `;
    }
    
    function renderCommandsWidget(id) {
      const body = document.getElementById(`body-${id}`);
      body.classList.add('no-padding');
      
      if (cache.commands.length === 0) {
        body.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö°</div><p class="empty-state-text">No commands</p></div>`;
        return;
      }
      
      body.innerHTML = `
        <table class="commands-table">
          <thead><tr><th>User</th><th>Type</th><th>Status</th><th>Time</th></tr></thead>
          <tbody>
            ${cache.commands.slice(0, 10).map(c => `
              <tr>
                <td><span class="user-id-cell">${maskId(c.user_id)}</span></td>
                <td>${c.drop_type || 'ask'}</td>
                <td><span class="status-badge ${c.exec_status || 'pending'}">${c.exec_status || 'pending'}</span></td>
                <td>${timeAgo(c.created_at)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }
    
    function renderTestersWidget(id) {
      const body = document.getElementById(`body-${id}`);
      
      const byUser = {};
      cache.drops.forEach(d => {
        if (!d.user_id) return;
        if (!byUser[d.user_id]) byUser[d.user_id] = { drops: 0, lastActivity: null };
        byUser[d.user_id].drops++;
        if (!byUser[d.user_id].lastActivity || d.created_at > byUser[d.user_id].lastActivity) {
          byUser[d.user_id].lastActivity = d.created_at;
        }
      });
      
      const tierMap = {};
      cache.users.forEach(u => tierMap[u.user_id] = u.tier);
      
      const users = Object.entries(byUser)
        .map(([id, data]) => ({ id, ...data, tier: tierMap[id] || 'free' }))
        .sort((a, b) => new Date(b.lastActivity) - new Date(a.lastActivity))
        .slice(0, 6);
      
      if (users.length === 0) {
        body.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üë•</div><p class="empty-state-text">No users</p></div>`;
        return;
      }
      
      body.innerHTML = `
        <div class="testers-grid">
          ${users.map(u => {
            const hrs = (Date.now() - new Date(u.lastActivity)) / 3600000;
            const statusClass = hrs < 1 ? 'online' : hrs < 24 ? 'recent' : 'offline';
            const statusText = hrs < 1 ? 'Online' : hrs < 24 ? 'Today' : Math.floor(hrs/24) + 'd';
            return `
              <div class="tester-card ${hrs < 24 ? 'active' : ''}">
                <div class="tester-header">
                  <div class="tester-avatar">${u.id[0].toUpperCase()}</div>
                  <span class="tester-status ${statusClass}">${statusText}</span>
                </div>
                <div class="tester-name">${maskId(u.id)}</div>
                <div class="tester-tier">${u.tier}</div>
                <div class="tester-stats">
                  <div class="tester-stat"><div class="tester-stat-value">${u.drops}</div><div class="tester-stat-label">Drops</div></div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
    
    function renderHourlyWidget(id) {
      const body = document.getElementById(`body-${id}`);
      const hourCounts = new Array(24).fill(0);
      const now = new Date();
      const h24ago = new Date(Date.now() - 24 * 3600000);
      
      cache.drops.filter(d => new Date(d.created_at) >= h24ago).forEach(d => {
        const hrs = Math.floor((now - new Date(d.created_at)) / 3600000);
        if (hrs >= 0 && hrs < 24) hourCounts[23 - hrs]++;
      });
      
      const max = Math.max(...hourCounts, 1);
      body.innerHTML = `<div class="hourly-chart">${hourCounts.map(c => `<div class="hourly-bar" style="height:${Math.max(c/max*100,3)}%" title="${c}"></div>`).join('')}</div>`;
    }
    
    function renderTimelineWidget(id) {
      const body = document.getElementById(`body-${id}`);
      const recent = cache.drops.slice(0, 8);
      
      if (recent.length === 0) {
        body.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üïê</div><p class="empty-state-text">No activity</p></div>`;
        return;
      }
      
      body.innerHTML = `<div class="timeline">${recent.map(d => `
        <div class="timeline-item">
          <div class="timeline-dot ${d.drop_group === 'command' ? 'command' : 'drop'}"></div>
          <div class="timeline-content"><span class="timeline-text">${maskId(d.user_id)} ¬∑ ${d.category || 'drop'}</span></div>
          <span class="timeline-time">${timeAgo(d.created_at)}</span>
        </div>
      `).join('')}</div>`;
    }
    
    function renderAlertsWidget(id) {
      const body = document.getElementById(`body-${id}`);
      const alerts = [
        { type: 'info', icon: '‚ÑπÔ∏è', title: 'System normal', desc: 'All services operational', time: 'now' }
      ];
      
      // Add real alerts based on data
      const pendingCount = cache.commands.filter(c => c.exec_status === 'pending').length;
      if (pendingCount > 5) {
        alerts.unshift({ type: 'warning', icon: '‚ö†Ô∏è', title: 'Commands queue', desc: `${pendingCount} pending commands`, time: 'now' });
      }
      
      body.innerHTML = `<div class="alerts-list">${alerts.map(a => `
        <div class="alert-item ${a.type}">
          <span class="alert-icon">${a.icon}</span>
          <div class="alert-content"><div class="alert-title">${a.title}</div><div class="alert-desc">${a.desc}</div></div>
          <span class="alert-time">${a.time}</span>
        </div>
      `).join('')}</div>`;
    }
    
    function renderActionsWidget(id) {
      const body = document.getElementById(`body-${id}`);
      body.innerHTML = `
        <div class="quick-actions">
          <button class="quick-btn" data-worker="process_queue">üîÑ Process Queue</button>
          <button class="quick-btn" data-worker="process_events">‚ö° Events</button>
          <button class="quick-btn" data-worker="generate_embeddings">üß† Embeddings</button>
          <button class="quick-btn" data-worker="cleanup_expired">üßπ Cleanup</button>
        </div>
      `;
    }
    
    // Quick actions
    document.addEventListener('click', async e => {
      const btn = e.target.closest('[data-worker]');
      if (!btn) return;
      btn.disabled = true;
      const txt = btn.textContent;
      btn.textContent = '‚è≥...';
      const r = await workerCall(btn.dataset.worker);
      showToast(r.error ? '‚ùå Failed' : '‚úÖ Done');
      btn.textContent = txt;
      btn.disabled = false;
      refreshAll();
    });
    
    // ============ AUTH ============
    async function handleEmailLogin(e) {
      e.preventDefault();
      const { error } = await sb.auth.signInWithPassword({
        email: document.getElementById('loginEmail').value,
        password: document.getElementById('loginPassword').value
      });
      if (error) showLoginError(error.message);
    }
    
    async function handleGoogleLogin() {
      const { error } = await sb.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: window.location.origin + window.location.pathname }
      });
      if (error) showLoginError(error.message);
    }
    
    async function handleLogout() {
      if (confirm('Sign out?')) {
        await sb.auth.signOut();
        window.location.reload();
      }
    }
    
    function showLoginError(msg) {
      const el = document.getElementById('loginError');
      el.textContent = msg;
      el.style.display = 'block';
    }
    
    // ============ LAYOUT ============
    function saveLayout() {
      localStorage.setItem('cortex_v3_layout', JSON.stringify(grid.save(false)));
      showToast('‚úÖ Layout saved');
    }
    
    function resetLayout() {
      if (confirm('Reset layout?')) {
        localStorage.removeItem('cortex_v3_layout');
        loadLayout(DEFAULT_LAYOUT);
        showToast('‚Ü∫ Reset');
      }
    }
    
    function addWidget() {
      const available = Object.entries(WIDGETS)
        .filter(([id]) => !grid.getGridItems().find(el => el.gridstackNode?.id === id))
        .map(([id, w]) => `${id}: ${w.title}`)
        .join('\n');
      
      if (!available) { showToast('All widgets added'); return; }
      
      const id = prompt('Widget ID:\n\n' + available);
      if (id && WIDGETS[id]) {
        const w = WIDGETS[id];
        grid.addWidget({
          w: w.minW || 3, h: w.minH || 2, minW: w.minW, minH: w.minH, id,
          content: `
            <div class="widget-header">
              <span class="widget-title">${w.title}</span>
              <div class="widget-actions">
                <button class="widget-action" data-action="refresh" data-id="${id}">üîÑ</button>
                <button class="widget-action" data-action="remove" data-id="${id}">‚úï</button>
              </div>
            </div>
            <div class="widget-body" id="body-${id}"></div>
          `
        });
        w.render(id);
        showToast(`+ ${w.title}`);
      }
    }
    
    function toggleEditMode() {
      editMode = !editMode;
      document.getElementById('editModeToggle').classList.toggle('active', editMode);
      grid.enableMove(editMode);
      grid.enableResize(editMode);
    }
    
    // ============ UTILS ============
    function maskId(id) { return id ? id.substring(0, 6) + '...' : '--'; }
    function timeAgo(d) {
      if (!d) return '--';
      const s = Math.floor((Date.now() - new Date(d)) / 1000);
      if (s < 60) return 'now';
      if (s < 3600) return Math.floor(s / 60) + 'm';
      if (s < 86400) return Math.floor(s / 3600) + 'h';
      return Math.floor(s / 86400) + 'd';
    }
    
    function showToast(msg) {
      document.querySelector('.toast')?.remove();
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 2500);
    }
    
    init();
  </script>
</body>
</html>
